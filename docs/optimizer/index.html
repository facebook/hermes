<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.75">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Hermes Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Hermes Blog Atom Feed"><title data-react-helmet="true">Design of the Optimizer | Hermes</title><meta data-react-helmet="true" property="og:url" content="https://hermesengine.dev/docs/optimizer"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Design of the Optimizer | Hermes"><meta data-react-helmet="true" name="description" content="Introduction"><meta data-react-helmet="true" property="og:description" content="Introduction"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://hermesengine.dev/docs/optimizer"><link data-react-helmet="true" rel="alternate" href="https://hermesengine.dev/docs/optimizer" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://hermesengine.dev/docs/optimizer" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.154be723.css">
<link rel="preload" href="/assets/js/runtime~main.8ba2547b.js" as="script">
<link rel="preload" href="/assets/js/main.4baadd0d.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><div class="announcementBar_3WsW" style="background-color:#20232a;color:#fff" role="banner"><div class="announcementBarContent_3EUC">Support Ukraine ðŸ‡ºðŸ‡¦ <a target="_blank" rel="noopener noreferrer" href="https://opensource.fb.com/support-ukraine"> Help Provide Humanitarian Aid to Ukraine</a>.</div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Hermes Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Hermes Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Hermes</strong></a><a class="navbar__item navbar__link" href="/docs/building-and-running">Docs</a><a class="navbar__item navbar__link" href="/playground/">Playground</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/hermes" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Hermes Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Hermes Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Hermes</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/building-and-running">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/playground/">Playground</a></li><li class="menu__list-item"><a href="https://github.com/facebook/hermes" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Documentation</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/building-and-running">Building and Running</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/emscripten">Building with Emscripten</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cross-compilation">Cross Compilation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/language-features">Language Features</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/intl">Internationalization APIs</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/memory-profilers">Memory Profilers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/design">Design Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ir">Design of the IR</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/optimizer">Design of the Optimizer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/vm">VM Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/gengc">The GenGC Garbage Collector</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hades">The Hades Garbage Collector</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/modules">Modules</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/strings">Strings</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/regexp">RegExp</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Integrations</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/react-native-integration">React Native Integration</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Contributing</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/coding-standards">Coding Standards</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">Design of the Optimizer</h1></header><div class="markdown"><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="introduction"></a>Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">#</a></h3><p>This document describes the high-level design of the Hermes optimizer. The
Hermes optimizer transforms the Hermes IR into a more efficient representation
that preserves the original semantics of the program. The IR.md document describes
the design of the Hermes IR.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="key-concepts"></a>Key concepts<a class="hash-link" href="#key-concepts" title="Direct link to heading">#</a></h3><p>This section describes a few key concepts and ideas:</p><ul><li><p>The optimizer is responsible for optimizing the IR. IRGen and BytecodeGen
are not the right place for implementing optimizations. The parts of the
compiler that translate from one representation to another are inherently
complex because they require the understanding of the semantics of both
representations. Moreover, translators are not designed like optimizers.
They do not have good access to analysis and do not allow the separation
of the optimizer from the translation, which makes debugging more
difficult.</p></li><li><p>Passes: Optimizations are organized in passes. There are two kinds of
passes: function passes and module passes. Function passes can modify only
the functions that they operate on, while module passes operate on the whole
module.  Function passes are allowed to read the whole module but only
touch the current function.</p></li><li><p>Analysis: Analyses are caches in front of a computation of some property.
For example, the dominator analysis is a cache that helps reduce compile
time by removing the need to recompute the dominator tree for each
function. Analyses are all about caching and invalidating pre-computed
properties.</p></li><li><p>Optimizations do one thing: Optimizations are designed to be simple and
this means that they do only one thing. For example, the common
subexpression elimination optimization does not delete dead code
&quot;on the way&quot; just because it can.</p></li><li><p>Optimizations are predictable: Sometimes there are several legal
representations of the program, but the optimizer should never
randomize the output of the compiler. Randomization of the output
happens when the output depends on runtime information such as the order
of elements in a set or map. Randomizing the output of the compiler
makes it very difficult to write tests and reproduce bugs. LLVM has
data structures that provide guaranteed order - use them!</p></li><li><p>Write compile-time efficient algorithms: The compile time of a compiler is a
very important metric and we attempt to minimize compile time as much as
possible. Do not write exponential algorithms (or polynomial algorithm with
a high degree). If you are writing a quadratic algorithm make sure to
implement a sliding-window or other techniques that will allows to limit
the quadratic search to a small subset of the graph. Always assume that
there exist a function with hundreds of consecutive basic blocks or a basic
block with thousands of instructions. If you are writing a &quot;solver&quot; then
you are probably doing it wrong.</p></li><li><p>There are three kinds of transformations: canonicalization,
simplification and lowering. Make sure that you know exactly what kind of
transformation you are doing and why. Canonicalizations are transformations that
expose opportunities for other transformations.  Re-association (reducing tree
height, placing constants on the RHS, etc.) is a canonicalization because it
organizes things in predictable patterns and makes the life of future
optimizations simpler by reducing the number of possible inputs. Inlining is
another example of effective canonicalization because it exposes opportunities
for optimizations in the caller function (by providing more information).
Another example is loop rotation, which is a canonical representation of all
loops.  In canonicalization we strive to clean up the program as much as
possible and reach a pure representation of the program.  Simplification is what
we normally think of as optimizations, like removing redundancy by deleting dead
code and optimizing arithmetic, etc.  Canonicalization can allow simplification
that can allow more canonicalization.  For example, de-virtualization unblocks
inlining that may allow some transformations that enable more de-virtualization.
Lowering transformations are the opposite of canonicalization. In Lowering
transformations we generate patterns that are closer to the target
representation. We may not be able to recover from lowering transformations. One
example for lowering transformation is loop strength reduction where the
optimizer transforms loop indices into non-consecutive accesses that fit with
the hardware instruction set. Another example is loop versioning where the body
of the loop is duplicated and versioned multiple times .</p></li></ul></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/hermes/blob/HEAD/website/../doc/Optimizer.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2020-12-12T07:36:13.000Z" class="lastUpdatedDate_1WI_">12/11/2020</time></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/ir"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Design of the IR</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/vm"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">VM Overview Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link">Introduction</a></li><li><a href="#key-concepts" class="table-of-contents__link">Key concepts</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/language-features">Language Features</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/building-and-running">Building and Running</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/emscripten">Building with Emscripten</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Integrations</h4><ul class="footer__items"><li class="footer__item"><a href="https://reactnative.dev/docs/hermes" target="_blank" rel="noopener noreferrer" class="footer__link-item">Using with React Native</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/react-native-integration">Using a custom build with React Native</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/HermesEngine" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://github.com/facebook/hermes" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/cookie-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cookies</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_MyFc"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2022 Facebook, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.8ba2547b.js"></script>
<script src="/assets/js/main.4baadd0d.js"></script>
</body>
</html>