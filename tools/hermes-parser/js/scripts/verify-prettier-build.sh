#!/bin/bash
# Copyright (c) Meta Platforms, Inc. and affiliates.
#
# This source code is licensed under the MIT license found in the
# LICENSE file in the root directory of this source tree.

# This script verifies that the committed index.mjs matches what would be
# generated by building the prettier fork.

set -xe -o pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MINIFIED_PRETTIER_PLUGIN="$SCRIPT_DIR/../prettier-plugin-hermes-parser/index.mjs"

# Save original file info BEFORE running the build
ORIGINAL_SIZE=$(wc -c < "$MINIFIED_PRETTIER_PLUGIN")
ORIGINAL_HASH=$(sha256sum "$MINIFIED_PRETTIER_PLUGIN" | awk '{print $1}')

# Run the build script
"$SCRIPT_DIR/build-prettier.sh"

# Check if index.mjs changed
if sl status "$MINIFIED_PRETTIER_PLUGIN" | grep -q .; then
    NEW_SIZE=$(wc -c < "$MINIFIED_PRETTIER_PLUGIN")
    NEW_HASH=$(sha256sum "$MINIFIED_PRETTIER_PLUGIN" | awk '{print $1}')

    echo "✗ index.mjs is out of sync with the prettier fork!"
    echo ""
    echo "The committed index.mjs does not match the build output."
    echo "Please run ./scripts/build-prettier.sh and commit the updated file."
    echo ""
    echo "File comparison:"
    echo "  Committed: $ORIGINAL_SIZE bytes (sha256: ${ORIGINAL_HASH:0:16}...)"
    echo "  Generated: $NEW_SIZE bytes (sha256: ${NEW_HASH:0:16}...)"
    exit 1
else
    echo "✓ index.mjs is up to date!"
    exit 0
fi
