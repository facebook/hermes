name: build-android

on: workflow_call

jobs:
  build-android:
    runs-on: 8-core-ubuntu
    env:
      HERMES_WS_DIR: /home/runner/work/hermes/hermes
    container:
      image: reactnativecommunity/react-native-android:latest
      env:
        TERM: "dumb"
        GRADLE_OPTS: "-Dorg.gradle.daemon=false"
        ORG_GRADLE_PROJECT_SIGNING_PWD: ${{ secrets.ORG_GRADLE_PROJECT_SIGNING_PWD }}
        ORG_GRADLE_PROJECT_SIGNING_KEY: ${{ secrets.ORG_GRADLE_PROJECT_SIGNING_KEY }}
        ORG_GRADLE_PROJECT_SONATYPE_USERNAME: ${{ secrets.ORG_GRADLE_PROJECT_SONATYPE_USERNAME }}
        ORG_GRADLE_PROJECT_SONATYPE_PASSWORD: ${{ secrets.ORG_GRADLE_PROJECT_SONATYPE_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Build Hermes Compiler
        run: |-
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
          # Build the Hermes compiler so that the cross compiler build can
          # access it to build the VM
          cmake --build ./build --target hermesc -j 4
      - name: Build android
        shell: bash
        run: |
          cd android
          TASKS="publishAllToMavenTempLocal build"
          ./gradlew $TASKS
      - name: Upload Maven Artifacts
        uses: actions/upload-artifact@v4.3.4
        with:
          name: maven-local
          path: /tmp/maven-local
