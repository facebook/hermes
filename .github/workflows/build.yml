name: facebook/hermes/build
on:
  push:
  pull_request:
    branches:
      - main
jobs:
  test-e2e-intl:
    runs-on: ubuntu-22.04
    env:
      HERMES_WS_DIR: /home/runner/work/hermes
      ANDROID_NDK: /usr/local/lib/android/sdk/ndk/27.1.12297006
    steps:
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'oracle'
    - name: Checkout Hermes
      uses: actions/checkout@v4.1.0
    - name: Checkout Test262
      run: |-
        cd "$HERMES_WS_DIR"
        git clone https://github.com/tc39/test262
        cd test262
        git checkout 62626e083bd506124aac6c799464d76c2c42851b
    - name: Build Hermes Compiler
      run: |-
        cd "$HERMES_WS_DIR"
        cmake -S hermes -B ./build -DCMAKE_BUILD_TYPE=Release
        cmake --build ./build -j 4 --target hermesc
    - name: Run android tests
      uses: ReactiveCircus/android-emulator-runner@v2.30.1
      with:
        api-level: 29
        emulator-options: -timezone Europe/Paris -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
        script: |
          adb logcat -c
          touch ./emulator.log
          chmod 777 ./emulator.log
          adb logcat >> ./emulator.log &
          cd android && ./gradlew :intltest:prepareTests && ./gradlew -Pabis=x86 :intltest:connectedAndroidTest
    - name: Upload emulator log
      if: always()
      uses: actions/upload-artifact@v4.3.4
      with:
        name: emulator.log
        path: emulator.log
